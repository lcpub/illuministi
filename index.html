<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Come voterebbe un illuminista? ‚Äî Profili, radar e lettere</title>

<style>
  :root{
    /* Palette ‚Äúpergamena / carta da zucchero‚Äù (chiara ma non abbagliante) */
    --bg1:#fbf7ef;
    --bg2:#f2eadc;
    --panel:#fbf8f1;
    --panel2:#f7f0e2;
    --ink:#fffdf8;

    --text:#1f2937;
    --muted:#51606b;

    --ok:#1f8a6b;
    --bad:#b23b2a;
    --warn:#b0892e;

    --line:#d6ccbd;
    --line2:#cbbfae;

    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
  }

  *{ box-sizing:border-box; }

  body{
    margin:0;
    font-family:var(--sans);
    background:
      radial-gradient(1200px 500px at 20% 0%, rgba(176,137,46,0.10), transparent 60%),
      radial-gradient(900px 500px at 90% 10%, rgba(31,138,107,0.10), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    color:var(--text);
    padding-bottom: 120px;
  }

  header{
    padding:18px 16px;
    border-bottom:1px solid var(--line);
    background: rgba(251,248,241,0.92);
    backdrop-filter: blur(6px);
    position: sticky; top:0; z-index: 10;
  }
  header h1{ margin:0 0 6px 0; font-size:20px; }
  header p{ margin:0; color:var(--muted); max-width:1100px; line-height:1.45; }

  main{
    max-width:1240px;
    margin:0 auto;
    padding:16px;
    display:grid;
    grid-template-columns: 1.05fr 0.95fr;
    gap:16px;
  }
  @media(max-width:980px){ main{ grid-template-columns:1fr; } }

  .card{
    background:rgba(251,248,241,0.92);
    border:1px solid var(--line);
    border-radius:14px;
    padding:14px;
    box-shadow: 0 10px 28px rgba(31,41,55,0.12);
  }
  .card h2{ margin:0 0 10px 0; font-size:16px; }
  .sub{ color:var(--muted); font-size:13px; line-height:1.45; }
  .hr{ height:1px; background:var(--line); margin:10px 0; }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .chip{
    background:rgba(247,240,226,0.8);
    border:1px solid var(--line2);
    padding:8px 10px;
    border-radius:999px;
    font-size:13px;
  }
  .chip b{ font-family:var(--mono); font-weight:900; }
  .chip.ok{ border-color: rgba(31,138,107,0.35); }
  .chip.bad{ border-color: rgba(178,59,42,0.35); }
  .chip.warn{ border-color: rgba(176,137,46,0.55); }

  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    overflow:hidden;
    border-radius:12px;
    border:1px solid var(--line);
    background: rgba(255,253,248,0.85);
  }
  th, td{ padding:10px 8px; border-bottom:1px solid var(--line); vertical-align:top; }
  th{ background:rgba(247,240,226,0.9); font-size:12px; color:var(--muted); text-align:left; }
  tr:last-child td{ border-bottom:none; }

  .code{ font-family:var(--mono); color:#334155; font-weight:900; }
  .desc{ color:var(--muted); font-size:12px; line-height:1.4; }
  .why{ color:#344256; font-size:12px; line-height:1.35; margin-top:6px; }

  input[type=number]{
    width:80px; padding:8px;
    background:var(--ink); color:var(--text);
    border:1px solid var(--line);
    border-radius:10px;
    font-family:var(--mono);
    font-size:13px;
  }

  button{
    background:rgba(247,240,226,0.95);
    color:var(--text);
    border:1px solid var(--line2);
    border-radius:12px;
    padding:10px 12px;
    cursor:pointer;
    font-weight:900;
  }
  button:hover{ filter:brightness(1.02); }
  button.secondary{
    background:rgba(251,248,241,0.92);
    font-weight:800;
  }

  canvas{
    background:var(--ink);
    border:1px solid var(--line);
    border-radius:14px;
    width:100%;
    height:430px;
    display:block;
  }

  .kpi{
    display:grid; gap:10px; grid-template-columns:1fr 1fr;
  }
  .kpi .box{
    border:1px solid var(--line);
    border-radius:14px;
    padding:12px;
    background:rgba(247,240,226,0.65);
  }
  .kpi .val{ font-family:var(--mono); font-size:20px; font-weight:900; margin-top:4px; }
  .kpi .lab{ color:var(--muted); font-size:12px; }

  details{
    border:1px solid var(--line);
    border-radius:12px;
    padding:10px 12px;
    background:rgba(247,240,226,0.55);
    margin-top:10px;
  }
  details summary{ cursor:pointer; font-weight:900; }
  details p, details li{ color:var(--muted); font-size:13px; line-height:1.45; }

  .profiles{ display:grid; gap:12px; }
  .profile{
    display:grid; grid-template-columns: 84px 1fr; gap:12px;
    border:1px solid var(--line);
    border-radius:14px;
    padding:12px;
    background:rgba(255,253,248,0.75);
  }
  .profile.compareOn{
    border-color: rgba(176,137,46,0.75);
    box-shadow: 0 0 0 1px rgba(176,137,46,0.22) inset;
  }
  .profile img{
    width:84px; height:84px;
    object-fit:cover;
    border-radius:14px;
    border:1px solid var(--line);
    background:rgba(0,0,0,0.03);
  }
  .profile h3{ margin:0; font-size:14px; }
  .profile .bio{ margin-top:4px; color:var(--muted); font-size:12px; line-height:1.4; }
  .profile .quote{
    margin-top:8px;
    padding:8px 10px;
    border-left:4px solid rgba(176,137,46,0.95);
    background:rgba(247,240,226,0.55);
    border-radius:10px;
    color:var(--text);
    font-size:12px;
    line-height:1.45;
  }
  .profile .btnrow{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }

  .miniTable{
    margin-top:10px;
    border:1px solid var(--line);
    border-radius:12px;
    overflow:hidden;
    background:rgba(255,253,248,0.75);
  }
  .miniTable table{ border:none; border-radius:0; background:transparent; }
  .miniTable th, .miniTable td{ border-bottom:1px solid var(--line); padding:8px; }
  .miniTable tr:last-child td{ border-bottom:none; }
  .miniTable th{ background:rgba(247,240,226,0.85); }

  .disclaimer{
    position:fixed; left:0; right:0; bottom:0;
    border-top:1px solid var(--line);
    background:rgba(251,248,241,0.94);
    backdrop-filter: blur(6px);
    padding:10px 12px;
    z-index:9999;
  }
  .disclaimer .wrap{
    max-width:1240px; margin:0 auto;
    display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
  }
  .disclaimer strong{ color:var(--warn); }
  .disclaimer .text{
    color:var(--muted);
    font-size:12px;
    line-height:1.4;
    max-width:980px;
  }
  .disclaimer button{
    padding:8px 10px;
    border-radius:999px;
    font-size:12px;
    background:rgba(247,240,226,0.95);
  }
  .sources{
    display:none;
    margin-top:8px;
    padding-top:8px;
    border-top:1px dashed rgba(203,191,174,0.9);
    width:100%;
  }

  .letterBox{
    border:1px solid rgba(176,137,46,0.45);
    background: linear-gradient(180deg, rgba(247,240,226,0.85), rgba(255,253,248,0.85));
    border-radius:14px;
    padding:12px 12px 10px 12px;
    margin-top:10px;
  }
  .letterBox .sig{
    margin-top:8px;
    color: var(--muted);
    font-size:12px;
  }
  .letterBox .dropcap{ font-family: var(--serif); }
  .letterBox .dropcap::first-letter{
    float:left;
    font-size:34px;
    line-height:1;
    padding-right:6px;
    font-weight:900;
    color: rgba(176,137,46,0.95);
    font-family: var(--serif);
  }

  .legendRow{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    margin-top:8px;
  }
  .legend{
    display:flex; align-items:center; gap:8px;
    font-size:12px; color:var(--muted);
    border:1px solid var(--line);
    background:rgba(247,240,226,0.55);
    padding:6px 10px;
    border-radius:999px;
  }
  .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }

  .tilt{
    margin-top:6px;
    font-size:12px;
    color: rgba(176,137,46,0.95);
    font-weight:900;
  }
  .tilt small{
    color:var(--muted);
    font-weight:700;
  }
</style>
</head>

<body>
<header>
  <h1>üó≥Ô∏è Come voterebbe un illuminista? ‚Äî confronto valori (1‚Äì10)</h1>
  <p>
    <b>Cosa fai tu:</b> dai un voto <b>da 1 a 10</b> a ogni criterio.
    <br>
    <b>In pi√π:</b> puoi <b>confrontare</b> un profilo (senza cambiare i tuoi voti) sovrapponendolo nel radar.
  </p>
</header>

<main>
  <!-- LEFT -->
  <section class="card">
    <h2>1) Voti dell‚Äôelettore (1‚Äì10)</h2>
    <div class="sub">
      Non devi ‚Äúdividere 100 punti‚Äù. Basta dare un voto a ciascun criterio.
      Se due criteri sono ugualmente importanti, dai lo stesso voto.
    </div>

    <div class="row" style="margin-top:10px">
      <span class="chip warn" id="sumChip">Somma dei tuoi voti = <b>‚Äî</b></span>
      <span class="chip ok" id="normChip">Pesi (normalizzati) = <b>1.00</b></span>
      <button id="btnReset">Reset</button>
      <button id="btnAll5">Tutti a 5</button>
    </div>

    <div class="hr"></div>

    <table>
      <thead>
        <tr>
          <th style="width:7%">Cod.</th>
          <th>Criterio</th>
          <th style="width:16%">Il tuo voto (1‚Äì10)</th>
          <th style="width:12%">Peso w</th>
        </tr>
      </thead>
      <tbody id="criteriaBody"></tbody>
    </table>

    <details>
      <summary>Motivazioni (in breve)</summary>
      <ul id="motivationList"></ul>
      <p class="desc">
        Il modello √® ‚Äútrasparente‚Äù: mostra anche se un criterio, per come sono stimati i punteggi, tende un poco verso S√å o verso NO.
        (Questo riflette una lettura ‚Äúsettecentesca‚Äù prudenziale verso possibili leve di controllo politico).
      </p>
    </details>

    <div class="miniTable" style="margin-top:12px">
      <table>
        <thead>
          <tr><th colspan="4">Riepilogo elettore ‚Äî per criterio</th></tr>
          <tr><th>Cod.</th><th>Voto</th><th>Peso w</th><th>Nota</th></tr>
        </thead>
        <tbody id="electorSummary"></tbody>
      </table>
    </div>
  </section>

  <!-- RIGHT -->
  <aside class="card">
    <h2>2) Grafico + giudizio</h2>

    <div class="kpi">
      <div class="box">
        <div class="lab">Indice S√å (0‚Äì10)</div>
        <div id="siScore" class="val">‚Äî</div>
      </div>
      <div class="box">
        <div class="lab">Indice NO (0‚Äì10)</div>
        <div id="noScore" class="val">‚Äî</div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <span class="chip" id="winner">Esito: <b>‚Äî</b></span>
      <span class="chip" id="delta">Differenza (S√å‚àíNO): <b>‚Äî</b></span>
    </div>

    <div class="sub" id="whyChoice" style="margin-top:8px">‚Äî</div>

    <details style="margin-top:10px;">
      <summary>Perch√© vince S√å o NO (contributi per criterio)</summary>
      <div class="desc" style="margin-top:8px;">
        La differenza totale √® la somma di <b>w √ó (S√å‚àíNO)</b> su ciascun criterio:
        se la somma √® positiva, tende S√å; se negativa, tende NO.
      </div>
      <div class="miniTable" style="margin-top:10px;">
        <table>
          <thead>
            <tr><th colspan="5">Contributi al risultato</th></tr>
            <tr>
              <th style="width:8%">Cod.</th>
              <th>Criterio</th>
              <th style="width:12%">Peso w</th>
              <th style="width:12%">S√å‚àíNO</th>
              <th style="width:16%">w√ó(S√å‚àíNO)</th>
            </tr>
          </thead>
          <tbody id="contribBody"></tbody>
          <tfoot>
            <tr>
              <th colspan="4">Somma contributi (Œî)</th>
              <th id="contribSum">‚Äî</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </details>

    <div class="letterBox">
      <div style="font-weight:900; margin-bottom:6px;">Lettera persiana (sintesi)</div>
      <div id="lettreElector" class="dropcap" style="font-size:13px; line-height:1.55;">‚Äî</div>
      <div class="sig" id="lettreElectorSig">‚Äî</div>
    </div>

    <div class="hr"></div>

    <canvas id="radar" width="980" height="520"></canvas>

    <div class="legendRow">
      <div class="legend"><span class="dot" style="background: rgba(176,137,46,0.95)"></span> Elettore (tu)</div>
      <div class="legend" id="legendCompare" style="display:none;">
        <span class="dot" style="background: rgba(31,138,107,0.95)"></span> <span id="legendCompareName">Profilo</span>
      </div>
    </div>

    <div class="sub" id="compareNote" style="margin-top:8px; display:none;">‚Äî</div>

    <div class="hr"></div>

    <h2>3) Profili + confronto</h2>
    <div class="sub">
      <b>Confronta</b> = sovrappone i voti del profilo ai tuoi nel radar (senza cambiarli).
      <br><b>Giudizio del profilo</b> = calcola l‚Äôesito ‚Äúcome se‚Äù quel profilo fosse l‚Äôelettore.
    </div>

    <div class="profiles" id="profiles"></div>
  </aside>
</main>

<div class="disclaimer">
  <div class="wrap">
    <div class="text">
      <strong>Nota:</strong> il risultato √® una raccomandazione di coerenza; il radar mostra priorit√† (importanze).
      <br>
      <span class="desc">Il modello mantiene un <b>lieve</b> ‚Äútilt prudenziale‚Äù (tipico di molte teorie settecentesche) verso il rischio che leve politiche o disciplinari comprimano l‚Äôindipendenza nel tempo.</span>
    </div>
    <button id="toggleSources">Mostra note</button>
    <div class="sources" id="sourcesBox">
      <div class="desc">
        <b>Alta Corte disciplinare (contesto):</b> la riforma prevede un organo disciplinare nuovo con una quota laica anche legata a elenchi predisposti dal Parlamento e a nomine, e un presidente eletto tra i laici; varie analisi discutono il rischio (o il beneficio) di questa scelta in termini di equilibrio tra poteri.
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   0) Criteri + punteggi (con lieve tilt prudenziale)
   Diffs (S√å‚àíNO): C1=-3, C2=+2, C3=0, C4=0, C5=+1, C6=-1
   => lieve prudenza (NO) ma non schiacciante: C2 e C5 tengono vivo il S√å.
   =========================== */
const criteria = [
  { code:"C1",
    title:"Distanza del giudicare dalla politica",
    si:6, no:9,
    sci:"Quanto l‚Äôassetto riduce pressioni e incentivi politici sul giudice (nomina ‚â† controllo): la paura dell‚Äôinterferenza √® nemica della libert√†.",
    quote:"Un giudice timoroso non protegge: obbedisce.",
    tiltNote:"Tende al NO (prudenza settecentesca: evitare leve politiche sulla giurisdizione)."
  },
  { code:"C2",
    title:"Terziet√† e imparzialit√† percepita del giudice",
    si:8, no:6,
    sci:"Quanto l‚Äôassetto rende credibile la neutralit√† tra accusa e difesa. Nel linguaggio dei Lumi: separare ruoli per ridurre sospetto e pre-giudizio.",
    quote:"La giustizia deve essere giusta, e anche parere tale.",
    tiltNote:"Tende al S√å (accento sulla terziet√† del giudice)."
  },
  { code:"C3",
    title:"Libert√† come sicurezza (fiducia nel processo)",
    si:6, no:6,
    sci:"Quanto l‚Äôassetto aumenta prevedibilit√† e riduce il timore dell‚Äôarbitrio. Qui S√å e NO rivendicano entrambi ‚Äòsicurezza‚Äô: cambia il tipo di rischio temuto.",
    quote:"La libert√† comincia quando cessa il timore dell‚Äôarbitrio.",
    tiltNote:"Neutro (dipende da quali rischi temi di pi√π)."
  },
  { code:"C4",
    title:"Leggi chiare, poco arbitrio interpretativo",
    si:7, no:7,
    sci:"Quanto l‚Äôassetto favorisce regole comprensibili e applicate in modo prevedibile (ridurre varianza e discrezionalit√† indebita).",
    quote:"La legge deve parlare chiaro.",
    tiltNote:"Neutro."
  },
  { code:"C5",
    title:"Anticattura, correnti e disciplina credibile",
    si:7, no:6,
    sci:"Quanto l‚Äôassetto riduce cattura (correntismo o altre fazioni) e rende credibile la disciplina. Per√≤: un organo disciplinare nuovo con quota laica legata a elenchi/nomine pu√≤ essere letto come accountability (S√å) o come leva di pressione politica (NO).",
    quote:"Chi controlla i controllori decide molto pi√π di quanto dica.",
    tiltNote:"Tende al S√å, ma con ambivalenza reale sul profilo ‚Äòcontrollo politico‚Äô."
  },
  { code:"C6",
    title:"Contrappesi nel lungo periodo (stabilit√† e anti-deriva)",
    si:6, no:7,
    sci:"Quanto l‚Äôarchitettura regge nel tempo: contrappesi, indipendenza e responsabilit√† devono coesistere anche quando cambiano maggioranze e incentivi. Qui pesa anche come si percepisce il nuovo sistema disciplinare (garanzia o leva).",
    quote:"Ci√≤ che regge oggi deve reggere anche domani.",
    tiltNote:"Tende al NO (prudenza: diffidenza per nuovi centri di potere nel tempo)."
  }
];

function tiltLabel(diff){
  if(diff>0) return "tende al S√å";
  if(diff<0) return "tende al NO";
  return "neutro";
}

/* ===========================
   1) Elettore + confronto
   =========================== */
let electorVotes = [5,5,5,5,5,5];
let compareKey = null;

function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
function normalizeVotes(votes){
  const s = sum(votes);
  if(s<=0) return votes.map(_=>1/votes.length);
  return votes.map(v=>v/s);
}
function scoreOption(weights, which){
  let total = 0;
  for(let i=0;i<criteria.length;i++){
    const perf = (which==="si") ? criteria[i].si : criteria[i].no;
    total += weights[i] * perf;
  }
  return total;
}

/* ===========================
   2) Lettere (stabili)
   =========================== */
function hashStr(s){
  let h=2166136261>>>0;
  for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
  return h>>>0;
}
function pick(arr, seed){ return arr[seed % arr.length]; }

function electorLetter(recLabel, p1, p2, delta){
  const seed = hashStr([recLabel,p1,p2,String(Math.round(delta*100))].join("|"));
  const sal = pick(["Mio caro amico,","Signore,","Caro compatriota,"], seed);
  const incipit = pick([
    "Ho veduto che, quando gli uomini parlano di giustizia, spesso parlano di s√©; e perci√≤ conviene pesare pi√π che applaudire.",
    "In questi tempi la parola libert√† corre come moneta; ma si conosce la moneta vera quando non trema nella mano.",
    "Molti chiamano ragione ci√≤ che √® abitudine; io ho preferito far tacere l‚Äôabitudine e ascoltare l‚Äôordine delle importanze."
  ], seed>>>1);
  const nodo = pick([
    `Tra tutte le cose, due ti hanno guidato pi√π delle altre: <b>${p1}</b> e <b>${p2}</b>.`,
    `Nel tuo bilancio primeggiano <b>${p1}</b> e <b>${p2}</b>, e da qui muove il resto.`,
    `I tuoi pesi si raccolgono in due capi: <b>${p1}</b> e <b>${p2}</b>.`
  ], seed>>>2);

  const esito =
    recLabel==="si" ? "Per questi pesi, mi pare pi√π conforme dare assenso." :
    recLabel==="no" ? "Per questi pesi, mi pare pi√π conforme negare l‚Äôassenso." :
    "Per questi pesi, la bilancia non si dichiara; ed io non forzo la bilancia.";

  const chiosa = pick([
    "Non ti mando un decreto, ma una misura: e la misura, se √® onesta, non grida.",
    "Non ho l‚Äôarte di profetare; ho solo la pazienza di pesare.",
    "S‚Äôio errassi, errerei con te: perch√© i pesi sono tuoi, non miei."
  ], seed>>>3);

  return { text:`${sal}<br>${incipit}<br>${nodo}<br>${esito}<br><span style="color:rgba(81,96,107,0.95)">${chiosa}</span>`, sig:"‚Äî Usbek" };
}

const authorLetters = {
  montesquieu: ({p1,p2,rec}) => ({
    sig:"‚Äî Montesquieu",
    text:`Caro Rica,<br>
      la libert√† non √® un clamore: √® una tranquillit√† dell‚Äôanimo, nata dall‚Äôopinione di essere al sicuro.<br>
      Se tu poni in cima <b>${p1}</b>, guardi alla forma che impedisce al potere di confondersi; se innalzi <b>${p2}</b>, cerchi che la sentenza non porti odore di parte.<br>
      Per questa disposizione, ${rec}.<br>
      <span style="color:rgba(81,96,107,0.95)">I poteri si toccano per frenarsi; ma guai se s‚Äôabbracciano per dominare.</span>`
  }),
  beccaria: ({p1,p2,rec}) => ({
    sig:"‚Äî Beccaria",
    text:`Signore,<br>
      in materia penale la prima virt√π √® la certezza, la seconda √® la chiarezza; e dove mancano, nasce l‚Äôarbitrio con maschera d‚Äôequit√†.<br>
      Io ragiono come in un sillogismo: la maggiore √® <b>${p1}</b>; la minore √® <b>${p2}</b>; la conseguenza dev‚Äôessere libert√† o pena, non capriccio.<br>
      Secondo questo ordine, ${rec}.<br>
      <span style="color:rgba(81,96,107,0.95)">Quando il giudizio diventa invenzione, la sorte del cittadino diventa caso.</span>`
  }),
  madison: ({p1,p2,rec}) => ({
    sig:"‚Äî Madison",
    text:`To the People,<br>
      un governo deve prima governare gli uomini, e poi costringere s√© stesso a non oltrepassare misura.<br>
      Quando mi dici <b>${p1}</b> e <b>${p2}</b>, io odo una domanda: la struttura offre mezzi e motivi perch√© un potere arresti l‚Äôaltro?<br>
      Per questa architettura, ${rec}.<br>
      <span style="color:rgba(81,96,107,0.95)">Se gli uomini non sono angeli, le istituzioni non devono comportarsi come se lo fossero.</span>`
  }),
  hume: ({p1,p2,rec}) => ({
    sig:"‚Äî Hume",
    text:`Sir,<br>
      conviene supporre che molti agiscano per interesse pi√π che per virt√π; e non √® ingiuria, √® prudenza.<br>
      Se tu esalti <b>${p1}</b> e <b>${p2}</b>, bada che l‚Äôinteresse privato, incanalato, finisca per cooperare al bene pubblico.<br>
      Per questa considerazione, ${rec}.<br>
      <span style="color:rgba(81,96,107,0.95)">La libert√† non vive di fiducia: vive di diffidenze ordinate.</span>`
  }),
  burke: ({p1,p2,rec}) => ({
    sig:"‚Äî Burke",
    text:`Caro Signore,<br>
      io diffido delle rotture che promettono perfezione: spesso rompono ci√≤ che non sapevano riparare.<br>
      Se tu poni <b>${p1}</b> e <b>${p2}</b> a governo del giudizio, domanda se il mutamento corregge la parte che devia, senza decomporre l‚Äôintero corpo.<br>
      Per questo criterio, ${rec}.<br>
      <span style="color:rgba(81,96,107,0.95)">Si cambi per conservare: il rimedio migliore guarisce senza uccidere il paziente.</span>`
  }),
  kant: ({p1,p2,rec}) => ({
    sig:"‚Äî Kant",
    text:`Cittadino,<br>
      la questione non √® soltanto che cosa decidere, ma se tu possa giustificare la regola davanti a chiunque, senza eccezioni.<br>
      Se i tuoi primi pesi sono <b>${p1}</b> e <b>${p2}</b>, tu chiedi che il giudizio non dipenda dall‚Äôumore, ma da una forma che valga per tutti.<br>
      Perci√≤, ${rec}.<br>
      <span style="color:rgba(81,96,107,0.95)">La libert√† non √® licenza: √® vivere sotto leggi che la ragione pu√≤ dichiarare.</span>`
  }),
  tocqueville: ({p1,p2,rec}) => ({
    sig:"‚Äî Tocqueville",
    text:`Signore,<br>
      le democrazie hanno una pendenza naturale verso la centralizzazione; e la libert√†, invece, √® un‚Äôarte faticosa.<br>
      Se tu innalzi <b>${p1}</b> e <b>${p2}</b>, chiedi che la giustizia non divenga un solo centro da cui tutto dipende, ma un ordine di responsabilit√† e controlli.<br>
      Per questa ragione, ${rec}.<br>
      <span style="color:rgba(81,96,107,0.95)">Dove tutto si decide in alto, in basso si disimpara a volere.</span>`
  }),
  diderot: ({p1,p2,rec}) => ({
    sig:"‚Äî Diderot",
    text:`Amico,<br>
      il primo abuso √® l‚Äôoscurit√†: quando ci√≤ che decide della tua libert√† √® opaco, gi√† comanda pi√π del dovuto.<br>
      Se metti davanti <b>${p1}</b> e <b>${p2}</b>, tu vuoi che la giustizia sia un mestiere leale e comprensibile, non un rito che vive di segreti.<br>
      Per questo, ${rec}.<br>
      <span style="color:rgba(81,96,107,0.95)">La chiarezza √® una forma di giustizia; l‚Äôoscurit√†, una forma di comando.</span>`
  }),
  filangieri: ({p1,p2,rec}) => ({
    sig:"‚Äî Filangieri",
    text:`Signore,<br>
      la legislazione non √® un discorso: √® un‚Äôarte di garanzie. Se la regola √® incerta, la libert√† diventa un favore.<br>
      Quando tu elevi <b>${p1}</b> e <b>${p2}</b>, chiedi che l‚Äôordine riduca l‚Äôoccasione dell‚Äôarbitrio e renda stabile ci√≤ che oggi √® conteso.<br>
      Per questo, ${rec}.<br>
      <span style="color:rgba(81,96,107,0.95)">Si cerchi la regola che dura: non la promessa che brilla.</span>`
  })
};

function buildLettre(recLabel, topPrinciples, delta, authorKey){
  const p1 = topPrinciples[0] || "un primo principio";
  const p2 = topPrinciples[1] || "un secondo principio";
  const rec =
    recLabel==="si" ? "mi pare pi√π conforme dare assenso" :
    recLabel==="no" ? "mi pare pi√π conforme negare l‚Äôassenso" :
    "mi pare pi√π conforme sospendere il giudizio";

  if(!authorKey) return electorLetter(recLabel, p1, p2, delta);
  const fn = authorLetters[authorKey];
  if(!fn) return electorLetter(recLabel, p1, p2, delta);
  return fn({p1,p2,rec,delta});
}

/* ===========================
   3) Profili (con fallback immagini)
   =========================== */
function imgWithFallback(localPath, commonsFileName){
  const remote = "https://commons.wikimedia.org/wiki/Special:FilePath/" + encodeURIComponent(commonsFileName);
  return { local: localPath, remote };
}

const profileData = {
  montesquieu: {
    name:"Montesquieu", years:"1689‚Äì1755", icon:"‚öñÔ∏è",
    img: imgWithFallback("img/montesquieu.png","Montesquieu_1.png"),
    bio:"Libert√† come sicurezza e separazione dei poteri.",
    coreQuotes:["¬´ ‚Ä¶le pouvoir arr√™te le pouvoir. ¬ª"],
    votes:[9,8,8,4,4,7]
  },
  beccaria: {
    name:"Cesare Beccaria", years:"1738‚Äì1794", icon:"üìú",
    img: imgWithFallback("img/beccaria.jpg","Cesare_Beccaria_1738-1794.jpg"),
    bio:"Anti‚Äëarbitrio: legge chiara, giudice vincolato alla legge.",
    coreQuotes:["¬´ ‚Ä¶l‚Äôautorit√† d‚Äôinterpretare‚Ä¶ non pu√≤ risiedere presso i giudici‚Ä¶ ¬ª"],
    votes:[6,6,7,10,6,4]
  },
  madison: {
    name:"James Madison", years:"1751‚Äì1836", icon:"üèõÔ∏è",
    img: imgWithFallback("img/madison.jpg","James_Madison_Portrait2.jpg"),
    bio:"Contrappesi interni: ambizione contro ambizione.",
    coreQuotes:["‚ÄúAmbition must be made to counteract ambition.‚Äù"],
    votes:[6,6,6,3,8,10]
  },
  hume: {
    name:"David Hume", years:"1711‚Äì1776", icon:"üß†",
    img: imgWithFallback("img/hume.jpg","David_Hume.jpg"),
    bio:"Scettico istituzionale: assumere interesse privato, costruire controlli.",
    coreQuotes:["¬´ ‚Ä¶every man ought to be supposed a knave‚Ä¶ ¬ª"],
    votes:[6,5,6,4,8,9]
  },
  burke: {
    name:"Edmund Burke", years:"1729‚Äì1797", icon:"üß±",
    img: imgWithFallback("img/burke.jpg","Edmund_Burke_EMWEA.jpg"),
    bio:"Prudenza politica: riformare per preservare; diffida delle rotture.",
    coreQuotes:["‚ÄúA state without the means of some change‚Ä¶‚Äù"],
    votes:[8,6,8,5,7,9]
  },
  kant: {
    name:"Immanuel Kant", years:"1724‚Äì1804", icon:"üïäÔ∏è",
    img: imgWithFallback("img/kant.jpg","Immanuel_Kant_(portrait).jpg"),
    bio:"Emancipazione intellettuale e riforma graduale.",
    coreQuotes:["‚ÄúSapere aude!‚Äù"],
    votes:[7,7,7,6,6,6]
  },
  tocqueville: {
    name:"Alexis de Tocqueville", years:"1805‚Äì1859", icon:"üïØÔ∏è",
    img: imgWithFallback("img/tocqueville.jpg","Alexis_de_tocqueville.jpg"),
    bio:"Libert√† come ‚Äúarte‚Äù: la centralizzazione cresce naturalmente.",
    coreQuotes:["‚ÄúCentralization will be the natural government.‚Äù"],
    votes:[6,5,7,5,7,9]
  },
  diderot: {
    name:"Denis Diderot", years:"1713‚Äì1784", icon:"üìö",
    img: imgWithFallback("img/diderot.jpg","Denis_Diderot_portrait.jpg"),
    bio:"Enciclopedista: sospetto verso autorit√† non giustificate; spirito critico.",
    coreQuotes:["(Encyclop√©die: critica dell‚Äôautorit√† ricevuta)"],
    votes:[7,7,6,6,7,6]
  },
  filangieri: {
    name:"Gaetano Filangieri", years:"1752‚Äì1788", icon:"üè∫",
    img: imgWithFallback("img/filangieri.jpg","Portrait_of_Gaetano_Filangieri_MET_DP805362.jpg"),
    bio:"Riformatore giuridico: garanzie, chiarezza delle leggi, anti‚Äëarbitrio.",
    coreQuotes:["(Scienza della legislazione: razionalizzare le garanzie)"],
    votes:[7,7,7,9,6,6]
  }
};

function getCompareVotes(){
  if(!compareKey) return null;
  return profileData[compareKey]?.votes || null;
}

/* ===========================
   4) UI render
   =========================== */
const criteriaBody = document.getElementById("criteriaBody");
const motivationList = document.getElementById("motivationList");
const electorSummary = document.getElementById("electorSummary");
const contribBody = document.getElementById("contribBody");
const contribSum = document.getElementById("contribSum");

function renderCriteria(){
  criteriaBody.innerHTML = "";
  motivationList.innerHTML = "";
  for(let i=0;i<criteria.length;i++){
    const c = criteria[i];
    const diff = c.si - c.no;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="code">${c.code}</td>
      <td>
        <b>${c.title}</b>
        <div class="desc">${c.sci}</div>
        <div class="tilt">${tiltLabel(diff)} <small>(${c.si} vs ${c.no})</small></div>
        <div class="desc">${c.tiltNote || ""}</div>
        <div class="why"><i>${c.quote}</i></div>
      </td>
      <td>
        <input type="number" min="1" max="10" step="1" value="${electorVotes[i]}" id="v_${i}">
        <div class="desc">1=conta poco ¬∑ 10=conta moltissimo</div>
      </td>
      <td><span class="chip"><b id="w_${i}">‚Äî</b></span></td>
    `;
    criteriaBody.appendChild(tr);

    const li = document.createElement("li");
    li.textContent = `${c.title}: ${c.sci}`;
    motivationList.appendChild(li);
  }

  for(let i=0;i<criteria.length;i++){
    document.getElementById(`v_${i}`).addEventListener("input", (e)=>{
      electorVotes[i] = clamp(Number(e.target.value)||1, 1, 10);
      updateAll();
    });
  }
}

function renderProfiles(){
  const box = document.getElementById("profiles");
  box.innerHTML = "";

  Object.keys(profileData).forEach(key=>{
    const p = profileData[key];
    const card = document.createElement("div");
    card.className = "profile";
    card.id = `profile_${key}`;

    let miniRows = "";
    for(let i=0;i<criteria.length;i++){
      miniRows += `<tr><td class="code">${criteria[i].code}</td><td>${criteria[i].title}</td><td><b>${p.votes[i]}</b></td></tr>`;
    }

    card.innerHTML = `
      <img src="${p.img.local}" alt="Ritratto di ${p.name}"
           onerror="this.onerror=null; this.src='${p.img.remote}';">
      <div>
        <h3>${p.icon} ${p.name} <span class="desc">(${p.years})</span></h3>
        <div class="bio">${p.bio}</div>
        <div class="quote">${p.coreQuotes.map(q=>`<div>‚Ä¢ ${q}</div>`).join("")}</div>

        <div class="miniTable">
          <table>
            <thead><tr><th colspan="3">Voti del profilo (1‚Äì10) per criterio</th></tr>
            <tr><th style="width:7%">Cod.</th><th>Criterio</th><th style="width:10%">Voto</th></tr></thead>
            <tbody>${miniRows}</tbody>
          </table>
        </div>

        <div class="btnrow">
          <button data-compare="${key}">Confronta questi voti con i miei</button>
          <button data-eval="${key}" class="secondary">Giudizio del profilo</button>
        </div>

        <div class="desc" id="profileEval_${key}" style="margin-top:10px; display:none;"></div>
      </div>
    `;
    box.appendChild(card);
  });

  box.querySelectorAll("button[data-compare]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.getAttribute("data-compare");
      compareKey = (compareKey===key) ? null : key;
      refreshCompareHighlight();
      updateAll();
    });
  });

  box.querySelectorAll("button[data-eval]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const key = btn.getAttribute("data-eval");
      const el = document.getElementById(`profileEval_${key}`);
      if(!el) return;
      const open = el.style.display === "block";
      el.style.display = open ? "none" : "block";
      if(!open) el.innerHTML = buildProfileJudgementHTML(key);
    });
  });

  refreshCompareHighlight();
}

function refreshCompareHighlight(){
  const legend = document.getElementById("legendCompare");
  const legendName = document.getElementById("legendCompareName");
  Object.keys(profileData).forEach(k=>{
    const el = document.getElementById(`profile_${k}`);
    if(el) el.classList.toggle("compareOn", compareKey===k);
  });
  if(compareKey){
    legend.style.display="flex";
    legendName.textContent = profileData[compareKey].name;
  }else{
    legend.style.display="none";
  }
}

/* ===========================
   5) Sintesi / giudizi
   =========================== */
function topCriteriaFromWeights(weights){
  return weights.map((w,i)=>({w,i})).sort((a,b)=>b.w-a.w).slice(0,2).map(p=>p.i);
}

function buildJudgementText(si, no, weights){
  const d = si-no;
  const top2 = topCriteriaFromWeights(weights);
  const a = criteria[top2[0]], b = criteria[top2[1]];
  const baseWhy = `I principi dominanti (secondo i tuoi pesi) sono: ‚Äú${a.title}‚Äù e ‚Äú${b.title}‚Äù.`;

  if(Math.abs(d) < 0.0001) return { label:"pareggio", text:`Pareggio: S√å e NO risultano equivalenti. ${baseWhy}` };
  if(d>0) return { label:"si", text:`Consiglio di coerenza: tende a favorire S√å. ${baseWhy}` };
  return { label:"no", text:`Consiglio di coerenza: tende a favorire NO. ${baseWhy}` };
}

function diffSummary(aVotes, bVotes){
  const diffs = aVotes.map((v,i)=>({i, d: (bVotes[i]-v)}));
  diffs.sort((x,y)=>Math.abs(y.d)-Math.abs(x.d));
  const top = diffs.slice(0,3);
  const meanAbs = diffs.reduce((acc,x)=>acc+Math.abs(x.d),0)/diffs.length;
  const parts = top.map(x=>{
    const sign = x.d>0 ? "+" : "";
    return `${sign}${x.d} in ‚Äú${criteria[x.i].title}‚Äù`;
  });
  return { parts, meanAbs: meanAbs.toFixed(2) };
}

function buildProfileJudgementHTML(key){
  const p = profileData[key];
  const w = normalizeVotes(p.votes);
  const si = scoreOption(w, "si");
  const no = scoreOption(w, "no");
  const d = si-no;
  const top2 = topCriteriaFromWeights(w);

  const topText = top2.map(i=>`‚Äú${criteria[i].title}‚Äù`).join(" + ");
  const rec = d>0 ? "favorisce S√å" : d<0 ? "favorisce NO" : "pareggio";

  const topPrinciples = top2.map(i => criteria[i].title);
  const lettre = buildLettre(d>0 ? "si" : d<0 ? "no" : "pareggio", topPrinciples, d, key);

  return `
    <b>Giudizio sintetico (${p.name}):</b> indice S√å=${si.toFixed(2)}, NO=${no.toFixed(2)} ‚áí <b>${rec}</b>.<br>
    <b>Perch√©:</b> questo profilo d√† pi√π peso a ${topText}.<br>
    <span class="desc">‚Ä¢ ${p.coreQuotes[0] || ""}</span>

    <div class="letterBox" style="margin-top:10px;">
      <div style="font-weight:900; margin-bottom:6px;">Lettera (profilo)</div>
      <div class="dropcap" style="font-size:13px; line-height:1.55;">${lettre.text}</div>
      <div class="sig">${lettre.sig}</div>
    </div>
  `;
}

/* ===========================
   6) Radar poligonale completo (elettore vs profilo + distanze)
   =========================== */
const radarCanvas = document.getElementById("radar");
const radarCtx = radarCanvas.getContext("2d");

function fitCanvasToCSS(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const w = Math.max(320, Math.floor(rect.width));
  const h = Math.max(320, Math.floor(rect.height));
  const need = canvas.width !== Math.floor(w*dpr) || canvas.height !== Math.floor(h*dpr);
  if(need){
    canvas.width = Math.floor(w*dpr);
    canvas.height = Math.floor(h*dpr);
  }
  return { w, h, dpr };
}

function drawRadar(){
  const { w, h, dpr } = fitCanvasToCSS(radarCanvas);
  radarCtx.setTransform(dpr,0,0,dpr,0,0);
  radarCtx.clearRect(0,0,w,h);

  const n = criteria.length;
  const labels = criteria.map(c=>c.code);
  const full = criteria.map(c=>`${c.code} ¬∑ ${c.title}`);
  const A = electorVotes.map(v=>clamp(Number(v)||0,0,10));
  const Braw = getCompareVotes();
  const B = Braw ? Braw.map(v=>clamp(Number(v)||0,0,10)) : null;

  const cx = w*0.5, cy = h*0.56;
  const R  = Math.min(w,h)*0.33;
  const rot = -Math.PI/2;

  // titolo
  radarCtx.fillStyle = "rgba(31,41,55,0.92)";
  radarCtx.font = "14px var(--sans)";
  radarCtx.textAlign = "center";
  radarCtx.textBaseline = "top";
  radarCtx.fillText("Radar: importanze (1‚Äì10) ‚Äî Elettore vs Profilo", cx, 10);

  // griglia
  const gridCol = "rgba(99,102,241,0.00)";
  const gridStroke = "rgba(203,191,174,0.55)";
  for(let r=1;r<=5;r++) polygon((R*r)/5, gridStroke, 1);

  // assi
  const axisCol = "rgba(203,191,174,0.65)";
  for(let i=0;i<n;i++){
    const ang = rot + i*(2*Math.PI/n);
    line(cx,cy,cx+R*Math.cos(ang), cy+R*Math.sin(ang), axisCol, 1);
  }

  // tacche
  radarCtx.fillStyle = "rgba(95,107,115,0.9)";
  radarCtx.font = "12px var(--mono)";
  radarCtx.textBaseline = "middle";
  for(let t=0;t<=10;t+=2){
    const rr = (R*t)/10;
    radarCtx.fillText(String(t), cx, cy-rr);
  }

  // etichette
  radarCtx.fillStyle = "rgba(31,41,55,0.92)";
  radarCtx.font = "11px var(--sans)";
  for(let i=0;i<n;i++){
    const ang = rot + i*(2*Math.PI/n);
    const ux = Math.cos(ang), uy = Math.sin(ang);
    const x = cx + (R+24)*ux;
    const y = cy + (R+24)*uy;

    radarCtx.textAlign = (ux>0.25)?"left":(ux<-0.25)?"right":"center";
    radarCtx.textBaseline = (uy>0.25)?"top":(uy<-0.25)?"bottom":"middle";
    wrapText(full[i], x, y, 210, 13);
  }

  const AStroke="rgba(176,137,46,0.95)";
  const AFill  ="rgba(176,137,46,0.18)";
  const BStroke="rgba(31,138,107,0.95)";
  const BFill  ="rgba(31,138,107,0.14)";

  const ptsA = valuesToPts(A);
  drawDataset(ptsA, AStroke, AFill);
  drawPoints(ptsA, AStroke);
  drawPointLabels(ptsA, A, labels, AStroke, -8);

  if(B){
    const ptsB = valuesToPts(B);
    drawDataset(ptsB, BStroke, BFill);
    drawPoints(ptsB, BStroke);
    drawPointLabels(ptsB, B, labels, BStroke, +8);

    // segmenti distanza
    radarCtx.strokeStyle = "rgba(95,107,115,0.35)";
    radarCtx.lineWidth = 1;
    for(let i=0;i<n;i++){
      radarCtx.beginPath();
      radarCtx.moveTo(ptsA[i].x, ptsA[i].y);
      radarCtx.lineTo(ptsB[i].x, ptsB[i].y);
      radarCtx.stroke();
    }
  }

  function valuesToPts(values){
    const pts=[];
    for(let i=0;i<n;i++){
      const ang=rot+i*(2*Math.PI/n);
      const rr=R*(values[i]/10);
      pts.push({x:cx+rr*Math.cos(ang), y:cy+rr*Math.sin(ang), ang});
    }
    return pts;
  }
  function polygon(rr, stroke, lw){
    radarCtx.beginPath();
    for(let i=0;i<n;i++){
      const a=rot+i*(2*Math.PI/n);
      const x=cx+rr*Math.cos(a), y=cy+rr*Math.sin(a);
      if(i===0) radarCtx.moveTo(x,y); else radarCtx.lineTo(x,y);
    }
    radarCtx.closePath();
    radarCtx.strokeStyle=stroke; radarCtx.lineWidth=lw; radarCtx.stroke();
  }
  function line(x1,y1,x2,y2,col,lw){
    radarCtx.beginPath();
    radarCtx.moveTo(x1,y1); radarCtx.lineTo(x2,y2);
    radarCtx.strokeStyle=col; radarCtx.lineWidth=lw; radarCtx.stroke();
  }
  function drawDataset(pts, stroke, fill){
    radarCtx.beginPath();
    pts.forEach((p,idx)=> idx===0?radarCtx.moveTo(p.x,p.y):radarCtx.lineTo(p.x,p.y));
    radarCtx.closePath();
    radarCtx.fillStyle=fill; radarCtx.fill();
    radarCtx.strokeStyle=stroke; radarCtx.lineWidth=2; radarCtx.stroke();
  }
  function drawPoints(pts, color){
    radarCtx.fillStyle=color;
    pts.forEach(p=>{
      radarCtx.beginPath();
      radarCtx.arc(p.x,p.y,4,0,Math.PI*2);
      radarCtx.fill();
    });
  }
  function drawPointLabels(pts, values, codes, color, perpShift){
    radarCtx.font="11px var(--mono)";
    radarCtx.fillStyle=color;
    for(let i=0;i<pts.length;i++){
      const p=pts[i];
      const ux=Math.cos(p.ang), uy=Math.sin(p.ang);
      const px=-uy, py=ux;
      const out=12;
      const lx=p.x+ux*out+px*perpShift;
      const ly=p.y+uy*out+py*perpShift;

      radarCtx.textAlign=(ux>0.25)?"left":(ux<-0.25)?"right":"center";
      radarCtx.textBaseline=(uy>0.25)?"top":(uy<-0.25)?"bottom":"middle";

      const text=`${codes[i]} ${values[i].toFixed(0)}`;
      strokeText(text,lx,ly,"rgba(255,253,248,0.95)",3);
      radarCtx.fillText(text,lx,ly);
    }
  }
  function wrapText(text, x, y, maxW, lineH){
    const words=String(text).split(" ");
    let line="", lines=[];
    for(let i=0;i<words.length;i++){
      const test = line ? (line + " " + words[i]) : words[i];
      if(radarCtx.measureText(test).width>maxW && line){
        lines.push(line); line=words[i];
      }else{
        line=test;
      }
    }
    if(line) lines.push(line);

    const base=radarCtx.textBaseline;
    if(base==="bottom"){
      for(let i=0;i<lines.length;i++){
        radarCtx.fillText(lines[i], x, y-(lines.length-1-i)*lineH);
      }
    }else{
      for(let i=0;i<lines.length;i++){
        radarCtx.fillText(lines[i], x, y+i*lineH);
      }
    }
  }
  function strokeText(text,x,y,strokeColor,strokeWidth){
    radarCtx.save();
    radarCtx.strokeStyle=strokeColor;
    radarCtx.lineWidth=strokeWidth;
    radarCtx.lineJoin="round";
    radarCtx.strokeText(text,x,y);
    radarCtx.restore();
  }
}

/* ===========================
   7) Update
   =========================== */
function updateAll(){
  const weights = normalizeVotes(electorVotes);

  document.getElementById("sumChip").innerHTML = `Somma dei tuoi voti = <b>${sum(electorVotes)}</b>`;
  document.getElementById("normChip").innerHTML = `Pesi (normalizzati) = <b>${sum(weights).toFixed(2)}</b>`;

  for(let i=0;i<criteria.length;i++){
    const el = document.getElementById(`w_${i}`);
    if(el) el.textContent = weights[i].toFixed(3);
  }

  const si = scoreOption(weights,"si");
  const no = scoreOption(weights,"no");
  const d  = si-no;

  document.getElementById("siScore").textContent = si.toFixed(2);
  document.getElementById("noScore").textContent = no.toFixed(2);

  const win = document.getElementById("winner");
  const delta = document.getElementById("delta");
  win.classList.remove("ok","bad");
  delta.classList.remove("ok","bad");
  delta.innerHTML = `Differenza (S√å‚àíNO): <b>${d.toFixed(2)}</b>`;

  const judgement = buildJudgementText(si,no,weights);
  if(judgement.label==="si"){
    win.innerHTML = `Esito: <b>favorisce S√å</b>`;
    win.classList.add("ok"); delta.classList.add("ok");
  }else if(judgement.label==="no"){
    win.innerHTML = `Esito: <b>favorisce NO</b>`;
    win.classList.add("bad"); delta.classList.add("bad");
  }else{
    win.innerHTML = `Esito: <b>pareggio</b>`;
  }

  document.getElementById("whyChoice").innerHTML =
    `<b>Giudizio sintetico (elettore):</b> ${judgement.text}`;

  // Contributi
  contribBody.innerHTML = "";
  let sumContrib = 0;
  for(let i=0;i<criteria.length;i++){
    const diff = (criteria[i].si - criteria[i].no);
    const contrib = weights[i] * diff;
    sumContrib += contrib;
    contribBody.innerHTML += `
      <tr>
        <td class="code">${criteria[i].code}</td>
        <td>${criteria[i].title}</td>
        <td>${weights[i].toFixed(3)}</td>
        <td>${diff.toFixed(0)}</td>
        <td>${contrib.toFixed(3)}</td>
      </tr>
    `;
  }
  contribSum.textContent = sumContrib.toFixed(3);

  // Riepilogo
  electorSummary.innerHTML = "";
  const top2 = topCriteriaFromWeights(weights);
  for(let i=0;i<criteria.length;i++){
    const isTop = top2.includes(i);
    electorSummary.innerHTML += `
      <tr>
        <td class="code">${criteria[i].code}</td>
        <td><b>${electorVotes[i]}</b></td>
        <td>${weights[i].toFixed(3)}</td>
        <td class="desc">${isTop ? "Tra i pi√π influenti nel tuo risultato" : ""}</td>
      </tr>
    `;
  }

  // Lettera elettore
  const top2principles = top2.map(i => criteria[i].title);
  const lettre = buildLettre(judgement.label, top2principles, d, null);
  document.getElementById("lettreElector").innerHTML = lettre.text;
  document.getElementById("lettreElectorSig").textContent = lettre.sig;

  // Confronto profilo
  const note = document.getElementById("compareNote");
  const B = getCompareVotes();
  const legend = document.getElementById("legendCompare");
  const legendName = document.getElementById("legendCompareName");

  if(compareKey && B){
    legend.style.display = "flex";
    legendName.textContent = profileData[compareKey].name;
    const s = diffSummary(electorVotes, B);
    note.style.display = "block";
    note.innerHTML = `<b>Confronto con ${profileData[compareKey].name}:</b> differenze maggiori: ${s.parts.join("; ")}.
      <br><span class="desc">Distanza media (assoluta): <b>${s.meanAbs}</b> punti su 10.</span>`;
  }else{
    legend.style.display = "none";
    note.style.display = "none";
    note.innerHTML = "";
  }

  drawRadar();
}

/* ===========================
   8) Init
   =========================== */
function init(){
  renderCriteria();
  renderProfiles();

  document.getElementById("btnReset").addEventListener("click", ()=>{
    electorVotes = [5,5,5,5,5,5];
    for(let i=0;i<criteria.length;i++) document.getElementById(`v_${i}`).value = electorVotes[i];
    updateAll();
  });

  document.getElementById("btnAll5").addEventListener("click", ()=>{
    electorVotes = [5,5,5,5,5,5];
    for(let i=0;i<criteria.length;i++) document.getElementById(`v_${i}`).value = electorVotes[i];
    updateAll();
  });

  document.getElementById("toggleSources").addEventListener("click", ()=>{
    const box = document.getElementById("sourcesBox");
    const open = box.style.display === "block";
    box.style.display = open ? "none" : "block";
    document.getElementById("toggleSources").textContent = open ? "Mostra note" : "Nascondi note";
  });

  updateAll();
  window.addEventListener("resize", drawRadar);
}

init();
</script>
</body>
</html>